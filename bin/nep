#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var program = require('commander');
var log = require('../lib/util/log');
var nep = require('../');
var conf = require('../package.json');

program
    .version(conf.version, '-v, --version')
    .usage('[options] [file]')
    .option('-p, --port [port]', 'Specify the port nproxy will listen on(8989 by default)', parseInt)
    .option('-t, --throttle [number]','Specify the throttling rate in kbyte per second',parseInt)
    .option('-d, --debug', 'Enable debug mode');

program.parse(process.argv);

console.log(program);

var file = program.args[0];

if(!file){
    file = path.join(process.cwd(), 'config.js');
}
else{
    file = path.resolve(file);
}

if (!fs.existsSync(file)) {
    log.error('rule file ' + file + ' can not be found!');
    process.exit(0);
}

//if just use -t but not specify the value then default to 15
if(program.throttle == true){
    program.throttle = 15;
}

process.on('uncaughtException', function(err) {
    //throw(err);
    log.error('uncaughtException: ' + err.message);
});

var rules = require(file);



nep.create({
    port: program.port,
    debug: program.debug,
    throttle:program.throttle,
    rules: rules
});


